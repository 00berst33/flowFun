---
title: "flowFun"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{flowFun}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(flowFun) # rm
```

# Introduction


# Installation
```{r, eval = FALSE}
devtools::install_github("00berst33/flowFun")
```

# Reading in Data

Cytometry data often contains millions of cells, so to facilitate fast and efficient manipulation of these large datasets, this package encourages the use of the `data.table` data structure. #.......and so on........

Other advantages of using this data structure is that it is futureproof, as it can easily be converted to a `data.frame`, a structure found in base R. This also makes the package more flexible, as although it focuses on the use of the FlowSOM package for clustering, the package could easily be expanded to work with any other clustering algorithm the user may prefer.

flowFun allows the user to read .fcs files directly into a data table, either by specifying the directory containing all files, or by providing a list with the relative or absolute filepaths of each file of interest. The expression data for each sample are joined by row, and two columns are joined to the left of the table: `.id` and `cell_id`. 

# change name of .id column

```{r load-data}
library(flowCore)
library(flowFun)
# Specify path to .fcs file
file <- system.file("extdata", "setup.fcs", package = "flowFun") # filename
# Read in as tidytable
table <- getTableFromFCS(file)
# Check result
print(table)
```

# Preprocessing

Once setup files have been cleaned and a compensation matrix has been generated, the next step is to preprocess the raw data. This pipeline mostly automates this process, only requiring minimal input from the user. In order, the steps this pipeline implements are as follows:
   1. Removing margin events (i.e. values that fall outside the range the
      flow cytometer should be able to pick up).
   2. Removing doublets.
   3. Removing debris.
   4. Compensating the data.
   5. Performing a log-icle transformation on each channel.
   6. Removing dead cells.
   7. Quality control, to check and correct for occurrences like clogs, speed
      changes, etc. and flag any files that may be too low-quality to include
      in the analysis.

The script will output a few files to check for any mistakes. The first is a pdf highlighting the cells that were removed in each .fcs file. The others are plots 
for any files that were flagged during quality control, where each
channel is plotted against time and removed events are marked.

```{r preprocess}
# Read in data
file <- system.file("extdata", "sample_aggregate.fcs", package = "flowFun")
table <- getTableFromFCS(file)

# filename
comp_mat <- read.csv("compensation_matrix.csv", check.names = FALSE) # need to check colnames

# filename
ff <- read.FCS(file.path("inst", "extdata", "Ab_PHA_Ctrl AWB2.fcs"), truncate_max_value = FALSE) 

clean_table <- doPreprocessing(file.path("inst", "extdata"), # make input flexible
                               ld_channel = "BUV496-A", 
                               compensation = comp_mat,
                               transformation = ,
                               debris_gate = ,
                               live_gate = ,
                               nmad = 4)

# Run the following command to check that your channel/marker pairs are correct.
pData(parameters(ff))

# Rename channels if necessary.
# (parameters(ff))$desc[29] = "CD21"

# Get all channel names, excluding time, FSC, and SSC.
all_channels = as.vector(pData(parameters(ff))$name[which(!is.na(pData(parameters(ff))$desc))])

# Remove margin events.
ff_m = RemoveMargins(ff, c("FSC-A", all_channels))

# Create density plot to check for doublets.
plotDens(ff_m, c("FSC-A", "FSC-H"))

# Remove doublets. If you would like the gate to be more or less strict, you
# may edit the `nmad` parameter. Cells are kept if their ratio is smaller than the
# median ratio + `nmad` times the median absolute deviation of the ratios - in
# short, increase `nmad` to have a looser gate, and vice versa. The default is 4.
nmad = 3
ff_d = RemoveDoublets(ff_m, nmad = nmad)

# Create a plot highlighting removed cells to check the result. The final
# parameter may be edited to include more or less cells in the plot, but note
# that runtime increases with the number of cells used.
plot_before_after(ff_m, ff_d, "FSC-A", "FSC-H", 5000)

# Create a density plot to check for debris.
plotDens(ff_d, c("FSC-A", "SSC-A"))

# Ask user to draw a gate to remove debris via a pop-up window. NOTE: Drawing the 
# gate works similarly to FlowJo, where you click to place each point. However, to 
# close the gate, rather than double clicking, place your final point, and click 
# "Stop", then "Stop locator", in the top left of the window. The gate will then
# be saved to the "polygon_gate" variable and you may exit the pop-up window.
polygon_gate = cyto_gate_draw(x = ff_d,
                              alias = "non debris",
                              channels = c("FSC-A", "SSC-A"))
polygon_gate = polygon_gate$`non debris`

# Apply the gate to the data.
ff_g = ff_d[flowCore::filter(ff_d, polygon_gate)@subSet, ]

# Create a plot highlighting removed cells to check the result.
plot_before_after(ff_d, ff_g, "FSC-A", "SSC-A", 5000)

# Read in compensation matrix, rename columns, and apply it to the data.
comp_matrix = read.csv(comp_matrix_filepath, check.names = FALSE)[-1]
colnames(comp_matrix) = sub(" :: .*", "", colnames(comp_matrix))
ff_c = compensate(ff_g, comp_matrix)

# Estimate a log-icle transformation on each channel and apply it to the data.
trans = estimateLogicle(ff_c, all_channels)
ff_t = transform(ff_c, trans) # make transformation attribute in data table

# Create a plot to check for live/dead cells.
plotDens(ff_t, c(ld_channel, "FSC-A"))

# Ask the user to draw a gate on live cells.
ff_live_gate = cyto_gate_draw(x = ff_t,
                              alias = "live",
                              channels = c(ld_channel, "FSC-A"))
ff_live_gate = ff_live_gate$live

# Apply the live/dead gate to the data.
ff_l = ff_t[flowCore::filter(ff_t, ff_live_gate)@subSet, ]

# Create a plot highlighting removed cells to check the result.
plot_before_after(ff_t, ff_l, ld_channel, "FSC-A", 5000)
```



